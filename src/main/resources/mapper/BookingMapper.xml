<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tencent.wxcloudrun.dao.BookingMapper">

    <!-- BookingMapper.xml 中添加 -->
    <insert id="insertBatchBookings" parameterType="java.util.List">
        INSERT INTO booking (court_id, time_slot_id, date, user_id, price, status, created_at, updated_at)
        VALUES
        <foreach collection="bookings" item="booking" separator=",">
            (
            #{booking.courtId},
            #{booking.timeSlotId},
            #{booking.date},
            #{booking.userId},
            #{booking.price},
            #{booking.status},
            #{booking.createdAt},
            #{booking.updatedAt}
            )
        </foreach>
    </insert>

    <select id="selectBookingsByOrder" resultType="com.tencent.wxcloudrun.model.Booking">
        SELECT b.*, c.name as court_name, ts.start_time, ts.end_time
        FROM booking b
        JOIN court c ON b.court_id = c.id
        JOIN time_slot ts ON b.time_slot_id = ts.id
        WHERE b.order_id = #{orderId}
        ORDER BY b.date, ts.start_time
    </select>

    <update id="cancelBatchBookings">
        UPDATE booking
        SET status = #{status},
        updated_at = NOW()
        WHERE id IN
        <foreach collection="bookingIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = 'confirmed'  -- 只取消已确认的预订
    </update>

    <select id="selectBookingIdsByOrder" resultType="java.lang.Long">
        SELECT id FROM booking WHERE order_id = #{orderId} AND status = 'confirmed'
    </select>

    <update id="cancelBookingsByOrder">
        UPDATE booking
        SET status = #{status},
        updated_at = NOW()
        WHERE order_id = #{orderId}
        AND status = 'confirmed'  -- 只取消已确认的预订
    </update>

</mapper>